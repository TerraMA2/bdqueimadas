if("undefined"==typeof jQuery)throw new Error("TerraMA² WebComponents requires jQuery");if("undefined"==typeof ol)throw new Error("TerraMA² WebComponents requires Openlayers 3");define("TerraMA2WC/TerraMA2WebComponents",[],function(){var e=function(e){};return{init:e}}),define("TerraMA2WC/components/MapDisplay.TerraMA2WebComponents",["TerraMA2WC/TerraMA2WebComponents"],function(e){var t=null,r=null,n=null,a=new ol.Map({renderer:"canvas",target:"terrama2-map",view:new ol.View({projection:"EPSG:4326",center:[-55,-15],zoom:3})}),i=null,o=null,l=null,s=null,u=null,c=function(){return a},d=function(){var e=window.setInterval(function(){a.updateSize()},100);window.setTimeout(function(){clearInterval(e)},2e3)},p=function(e,t){var r=K(a.getLayerGroup(),"id",e);r.getSource().updateParams(t)},y=function(e){var t=parseFloat(e),r=parseFloat(e);if(r>180||-180>=r){e=0>r?-1*e:parseFloat(e);var n=0;n=r/180%2===-0?e/180:r/180%2===-1?e/180+1:e/180%1===0?e/180-1:parseInt(e/180)%2===0?parseInt(e/180):Math.ceil(e/180),n>0&&(t=0>r?r+180*n:r-180*n)}return t},f=function(){var e=!1;if(a.getControls().forEach(function(t,r){return t instanceof ol.control.MousePosition?void(e=!0):void 0}),!e){$("#terrama2-map").append('<div id="terrama2-map-info"></div>');var t=new ol.control.MousePosition({coordinateFormat:function(e){return function(t){return ol.coordinate.toStringXY([y(t[0]),t[1]],e)}}(6),projection:"EPSG:4326",className:"terrama2-mouse-position",target:document.getElementById("terrama2-map-info")});a.addControl(t)}},m=function(){$("#terrama2-map-info").remove(),a.getControls().forEach(function(e,t){return e instanceof ol.control.MousePosition?void a.removeControl(e):void 0})},v=function(){var e=!1;a.getControls().forEach(function(t,r){return t instanceof ol.control.ScaleLine?void(e=!0):void 0}),e||a.addControl(new ol.control.ScaleLine)},g=function(){a.getControls().forEach(function(e,t){return e instanceof ol.control.ScaleLine?void a.removeControl(e):void 0})},h=function(){var e=!1;a.getInteractions().forEach(function(t,r){return t instanceof ol.interaction.DoubleClickZoom?void(e=!0):void 0}),e||a.addInteraction(new ol.interaction.DoubleClickZoom)},x=function(){a.getInteractions().forEach(function(e,t){return e instanceof ol.interaction.DoubleClickZoom?void a.removeInteraction(e):void 0})},b=function(e,t){var r=new ol.layer.Group({id:e,name:t});return r},C=function(e,t){var r=K(a.getLayerGroup(),"id","terrama2-layerexplorer"),n=null!==r;if(n){var i=r.getLayers();i.push(b(e,t)),r.setLayers(i)}return n},L=function(e,t,r,n,a,i,o,l){var s={LAYERS:r,TILED:!0};null!==l&&void 0!==l&&""!==l&&(s.TIME=l);var u=new ol.layer.Tile({source:new ol.source.TileWMS({preload:1/0,url:e,serverType:t,params:s}),id:r,name:n,visible:a});return void 0!==i&&null!==i&&u.setMinResolution(i),void 0!==o&&null!==o&&u.setMaxResolution(o),u},w=function(e,t,r,n,i,o,l,s,u){var c=K(a.getLayerGroup(),"id",s),d=null!==c;if(d){var p=c.getLayers();p.push(L(e,t,r,n,i,o,l,u)),c.setLayers(p)}return d},M=function(e,t,r,n,a,i,o,l,s){var u=new ol.layer.Vector({source:new ol.source.Vector({url:e,format:new ol.format.GeoJSON,strategy:ol.loadingstrategy.bbox}),style:function(e){var t=s(e,o,l);return T(t.fillColor,t.strokeColor)},id:t,name:r,visible:n});return void 0!==a&&null!==a&&u.setMinResolution(a),void 0!==i&&null!==i&&u.setMaxResolution(i),u},S=function(e,t,r,n,i,o,l,s,u,c){var d=K(a.getLayerGroup(),"id",c),p=null!==d;if(p){var y=d.getLayers();y.push(M(e,t,r,n,i,o,l,s,u)),d.setLayers(y)}return p},E=function(e,t){var r=K(a.getLayerGroup(),"id","terrama2-layerexplorer"),n=null!==r;if(n){var i=r.getLayers();i.push(new ol.layer.Group({layers:[new ol.layer.Tile({source:new ol.source.OSM,id:"osm",name:"Open Street Map",visible:!1}),new ol.layer.Tile({source:new ol.source.MapQuest({layer:"osm"}),id:"mapquest_osm",name:"MapQuest OSM",visible:!1}),new ol.layer.Tile({source:new ol.source.MapQuest({layer:"sat"}),id:"mapquest_sat",name:"MapQuest Sat&eacute;lite",visible:!0})],id:e,name:t})),r.setLayers(i)}return n},V=function(e,t,r,n,a,i){u=i,s.emit("proxyRequest",{url:e,additionalParameters:{serverUrl:t,serverType:r,serverId:n,serverName:a}})},T=function(e,t){return new ol.style.Style({fill:new ol.style.Fill({color:e}),stroke:new ol.style.Stroke({color:t,width:2})})},k=function(e){if(e.setVisible(!e.getVisible()),e.getLayers)for(var t=e.getLayers().getArray(),r=t.length,n=0;r>n;n++)t[n].setVisible(e.getVisible());$(document).trigger("layerVisibilityChange",[e.get("id")])},G=function(e,t){var r=K(a.getLayerGroup(),"id",e);if(r.setVisible(t),r.getLayers)for(var n=r.getLayers().getArray(),i=n.length,o=0;i>o;o++)n[o].setVisible(t);$(document).trigger("layerVisibilityChange",[e])},A=function(e){var t=K(a.getLayerGroup(),"id",e);return t.get("visible")},I=function(e){$(document).unbind("layerVisibilityChange"),$(document).on("layerVisibilityChange",function(t,r){e(r)})},B=function(){a.addInteraction(t)},W=function(){a.removeInteraction(t)},D=function(){var e=t.getGeometry().getExtent();return e},R=function(e){t.on("boxstart",function(t){e()})},P=function(e){t.on("boxend",function(t){e()})},_=function(){var e=a.getView().calculateExtent(a.getSize());return e},Z=function(){a.getView().fit(r,a.getSize(),{constrainResolution:!1})},z=function(e){a.getView().fit(e,a.getSize(),{constrainResolution:!1})},F=function(){return a.getView().getResolution()},N=function(e){var t=K(a.getLayerGroup(),"id",e),r=F();return null!==t&&t.getMaxResolution()>=r&&t.getMinResolution()<=r},Q=function(e){null!==i&&a.getView().unByKey(i),i=a.getView().on("propertychange",function(t){switch(t.key){case"resolution":e()}})},O=function(e){null!==o&&a.getView().unByKey(o),o=a.on("dblclick",function(t){e(y(t.coordinate[0]),t.coordinate[1])})},q=function(e){null!==l&&a.getView().unByKey(l),l=a.on("click",function(t){e(y(t.coordinate[0]),t.coordinate[1])})},j=function(){null!==l&&a.getView().unByKey(l)},K=function(e,t,r){if(e.get(t)===r)return e;if(e.getLayers)for(var n,a=e.getLayers().getArray(),i=a.length,o=0;i>o;o++)if(n=K(a[o],t,r))return n;return null},J=function(e,t){K(a.getLayerGroup(),"id",t).getSource().updateParams({CQL_FILTER:e})},Y=function(e,t,r){var n=K(a.getLayerGroup(),"id",e).getLayers(),i=n.removeAt(t);n.insertAt(r,i)},U=function(){n=new ol.format.WMSCapabilities,a.getLayerGroup().set("id","terrama2-layerexplorer"),a.getLayerGroup().set("name","terrama2-layerexplorer"),t=new ol.interaction.DragBox({condition:ol.events.condition.always}),r=a.getView().calculateExtent(a.getSize()),$(document).ready(function(){d()})};return{getMap:c,updateMapSize:d,updateLayerSourceParams:p,addMousePosition:f,removeMousePosition:m,addScale:v,removeScale:g,enableDoubleClickZoom:h,disableDoubleClickZoom:x,addLayerGroup:C,createTileWMS:L,addTileWMSLayer:w,addGeoJSONVectorLayer:S,addBaseLayers:E,addCapabilitiesLayers:V,setLayerVisibility:k,setLayerVisibilityById:G,isLayerVisible:A,setLayerVisibilityChangeEvent:I,addZoomDragBox:B,removeZoomDragBox:W,getZoomDragBoxExtent:D,setZoomDragBoxStartEvent:R,setZoomDragBoxEndEvent:P,getCurrentExtent:_,zoomToInitialExtent:Z,zoomToExtent:z,getCurrentResolution:F,isCurrentResolutionValidForLayer:N,setMapResolutionChangeEvent:Q,setMapDoubleClickEvent:O,setMapSingleClickEvent:q,unsetMapSingleClickEvent:j,findBy:K,applyCQLFilter:J,alterLayerIndex:Y,init:U}}),define("TerraMA2WC/components/LayerExplorer.TerraMA2WebComponents",["TerraMA2WC/components/MapDisplay.TerraMA2WebComponents"],function(e){var t=null,r=null,n=null,a=function(){return t},i=function(e,t,r,n){return"<li data-layerid='"+e+"' data-parentid='"+r+"' id='"+e.replace(":","")+"' class='parent_li'><span class='group-name'><div class='terrama2-layerexplorer-plus'>+</div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+t+"</span><ul class='children'>"+n+"</ul></li>"},o=function(e,t,r,n){var a=n?"<input type='checkbox' class='terrama2-layerexplorer-checkbox' checked/>":"<input type='checkbox' class='terrama2-layerexplorer-checkbox'/>";return"<li data-layerid='"+e+"' data-parentid='"+r+"' id='"+e.replace(":","")+"' class='layer'>"+a+"<span class='terrama2-layerexplorer-checkbox-span'>"+t+"</span></li>"},l=function(e,t){var a=r.findBy(n.getLayerGroup(),"id",e);if(null!==a){var i=s(a,t);"terrama2-layerexplorer"===t?$("#"+t).prepend(i):$("#"+t+" > ul.children").prepend(i),$("input.opacity").slider(),$(".parent_li").find(" > ul > li").hide(),c()}},s=function(e,t){var r="";if(e.getLayers){for(var n="",a=e.getLayers().getArray(),l=a.length,u=0;l>u;u++){var c=n;n=s(a[u],e.get("id"))+c}$("#"+e.get("id").replace(":","")).length||(r=i(e.get("id"),e.get("name"),t,n))}else $("#"+e.get("id").replace(":","")).length||(r=o(e.get("id"),e.get("name"),t,e.get("visible")));return r},u=function(){$("#terrama2-layerexplorer").on("click","span.group-name",function(e){var t=$(this).parent("li.parent_li").find(" > ul > li");t.is(":visible")?(t.hide("fast"),$(this).find("div").addClass("terrama2-layerexplorer-plus").removeClass("terrama2-layerexplorer-minus").html("+"),$(this).parent("li.parent_li").removeClass("open")):(t.show("fast"),$(this).find("div").addClass("terrama2-layerexplorer-minus").removeClass("terrama2-layerexplorer-plus").html("-"),$(this).parent("li.parent_li").addClass("open"))}),$("input.opacity").on("slide",function(e){var t=$(this).closest("li").data("layerid"),a=r.findBy(n.getLayerGroup(),"id",t);a.setOpacity(e.value)}),$("#terrama2-layerexplorer").on("click","input.terrama2-layerexplorer-checkbox",function(e){var t=$(this).closest("li").data("layerid"),a=r.findBy(n.getLayerGroup(),"id",t);if(null!==a){r.setLayerVisibility(a);var i=$(this).parent("li.parent_li").find(" > ul > li"),o=$(this).parent("li.parent_li").find(" > span");i.is(":visible")||!a.getVisible()?(i.hide("fast"),o.find("div").addClass("terrama2-layerexplorer-plus").removeClass("terrama2-layerexplorer-minus").html("+")):(i.show("fast"),o.find("div").addClass("terrama2-layerexplorer-minus").removeClass("terrama2-layerexplorer-plus").html("-"))}e.stopPropagation()}),$("#terrama2-layerexplorer").on("click","li.layer",function(){$(this).hasClass("selected")?($(this).removeClass("selected"),t=null):($("li.parent_li ul li").removeClass("selected"),$(this).addClass("selected"),t=$(this).attr("data-layerid"))})},c=function(){$(".children").sortable({start:function(e,t){$(this).attr("data-previndex",t.item.context.parentNode.childElementCount-2-t.item.index())},update:function(t,r){e.alterLayerIndex(r.item.attr("data-parentid"),$(this).attr("data-previndex"),r.item.context.parentNode.childElementCount-1-r.item.index()),$(this).removeAttr("data-previndex")}}),$(".children").disableSelection(),$("#terrama2-layerexplorer").sortable({start:function(e,t){$(this).attr("data-previndex",t.item.context.parentNode.childElementCount-2-t.item.index())},update:function(t,r){e.alterLayerIndex(r.item.attr("data-parentid"),$(this).attr("data-previndex"),r.item.context.parentNode.childElementCount-1-r.item.index()),$(this).removeAttr("data-previndex")}}),$("#terrama2-layerexplorer").disableSelection()},d=function(){r=e,n=r.getMap(),u()};return{getSelectedLayer:a,addLayersFromMap:l,init:d}});